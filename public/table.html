<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Table</title>
  <link rel="stylesheet" href="/style.css" />
  <link rel="stylesheet" href="/table-variants.css" />
</head>
<body>
  <div class="wrap">
    <nav class="nav">
      <span style="font-weight:700;">JamPoker</span>
      <a href="/lobby.html">Lobby</a>
      <span id="debug-chip" class="small" style="margin-left:auto;cursor:pointer;padding:4px 8px;border:1px solid #334155;border-radius:8px;">Debug: OFF</span>
    </nav>
    <div id="you"></div>
    <div id="error" class="card" style="display:none;"></div>
    <div id="table-room">
      <div id="board-header"></div>
      <div id="community" class="community-cards"></div>
      <div id="seat-ring" class="seat-ring"></div>
    </div>
  </div>
  <div id="player-board" class="card" style="display:none;position:fixed;left:50%;bottom:0;transform:translateX(-50%);min-width:260px;"></div>
  <div id="debug-box" class="dbg" style="display:none;font-family:monospace;white-space:pre;font-size:11px;margin-top:12px;"></div>

  <script type="module" src="/firebase-init.js"></script>
  <script type="module">
    import { db, dollars, renderCurrentPlayerControls, isDebug, setDebug, getCurrentPlayer, formatCard, stageLabel, showSeatsDebug, debugLog } from "/common.js";
    import { doc, onSnapshot, collection, query, orderBy, addDoc, serverTimestamp, runTransaction, increment } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    renderCurrentPlayerControls("you");
    const debugChip = document.getElementById('debug-chip');
    debugChip.textContent = isDebug() ? 'Debug: ON' : 'Debug: OFF';
    debugChip.addEventListener('click', () => setDebug(!isDebug()));

    const params = new URLSearchParams(window.location.search);
    const variant = params.get('variant') || 'v1';
    document.body.dataset.variant = variant;

    let tableId = null;
    if (location.pathname.startsWith('/table/')) {
      tableId = location.pathname.split('/')[2];
    }
    if (!tableId) tableId = params.get('id');

    const errorEl = document.getElementById('error');
    const headerEl = document.getElementById('board-header');
    const communityEl = document.getElementById('community');
    const ringEl = document.getElementById('seat-ring');
    const boardEl = document.getElementById('player-board');
    const debugBox = document.getElementById('debug-box');

    let tableData = null;
    let handData = null;
    let seatData = [];
    let unsubHand = null;

    if (!tableId) {
      errorEl.style.display = 'block';
      errorEl.innerHTML = '<h1>Table not found</h1><a href="/lobby.html">Back to Lobby</a>';
    } else {
      const tableRef = doc(db, 'tables', tableId);
      onSnapshot(tableRef, (snap) => {
        debugLog('table.tableSnapshot', snap.exists());
        if (!snap.exists() || snap.data()?.active === false) {
          errorEl.style.display = 'block';
          const msg = !snap.exists() ? 'Table not found' : 'Table archived';
          errorEl.innerHTML = `<h1>${msg}</h1><a href="/lobby.html">Back to Lobby</a>`;
          boardEl.style.display = 'none';
          return;
        }
        errorEl.style.display = 'none';
        tableData = { id: snap.id, ...snap.data() };
        renderHeader();
        if (unsubHand) unsubHand();
        if (tableData.currentHandId) {
          const handRef = doc(db, 'tables', tableId, 'hands', tableData.currentHandId);
          unsubHand = onSnapshot(handRef, (hsnap) => {
            handData = hsnap.exists() ? hsnap.data() : null;
            renderHand();
            renderPlayerBoard();
            updateDebug();
          });
        } else {
          handData = null;
          renderHand();
          renderPlayerBoard();
          updateDebug();
        }
      });

      const seatsRef = collection(db, 'tables', tableId, 'seats');
      onSnapshot(query(seatsRef, orderBy('seatIndex', 'asc')), (snap) => {
        debugLog('table.seatsSnapshot', snap.size);
        seatData = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
        showSeatsDebug(tableId, snap.docs);
        renderSeats();
        renderHeader();
        renderHand();
        renderPlayerBoard();
        updateDebug();
      });
    }

    document.addEventListener('change', (e) => {
      if (e.target.id === 'cp-select') renderPlayerBoard();
    });

    function renderHeader() {
      if (!tableData) { headerEl.textContent = ''; return; }
      const t = tableData;
      const derivedSeatCount = seatData.filter(s => s.occupiedBy).length;
      const maxSeats = t.maxSeats || seatData.length;
      headerEl.innerHTML = `
        <h1>${t.name || '(no name)'}</h1>
        <div class="small">${derivedSeatCount} / ${maxSeats} seated</div>
        <div class="small">Pot: ${dollars(handData?.potCents || 0)}</div>
      `;
    }

    function renderHand() {
      if (!handData) { communityEl.innerHTML = ''; return; }
      const board = (handData.board || []).map(c => `<span class="card-chip">${formatCard(c)}</span>`).join(' ');
      communityEl.innerHTML = board;
    }

    async function seatAction(seat) {
      const cp = getCurrentPlayer();
      if (!cp) { alert('Select a Current Player first.'); return; }
      try {
        if (seat.occupiedBy && seat.occupiedBy === cp.id) {
          await leaveSeat(cp);
        } else if (!seat.occupiedBy) {
          await claimSeat(seat.seatIndex, cp);
        }
      } catch (err) {
        alert(err?.message || err);
      }
    }

    function renderSeats() {
      const maxSeats = tableData?.maxSeats || 0;
      ringEl.innerHTML = '';
      const size = ringEl.offsetWidth;
      const radius = size / 2 - 50;
      const center = size / 2;
      for (let i = 0; i < maxSeats; i++) {
        const seat = seatData.find(s => s.seatIndex === i) || { seatIndex: i };
        const angle = (2 * Math.PI * i / maxSeats) - Math.PI / 2;
        const x = center + radius * Math.cos(angle);
        const y = center + radius * Math.sin(angle);
        const btn = document.createElement('button');
        btn.className = 'seat';
        btn.style.left = `${x}px`;
        btn.style.top = `${y}px`;
        if (seat.occupiedBy === getCurrentPlayer()?.id) btn.classList.add('you');
        if (handData && i === handData.actorSeatNum) btn.classList.add('active');
        const span = document.createElement('span');
        span.className = 'seat-label';
        span.textContent = seat.displayName || 'Sit';
        btn.appendChild(span);
        btn.addEventListener('click', () => seatAction(seat));
        ringEl.appendChild(btn);
      }
    }

    let intentPending = false;
    async function renderPlayerBoard() {
      const current = getCurrentPlayer();
      if (!current) { boardEl.style.display = 'none'; return; }
      const seat = seatData.find(s => s.occupiedBy === current.id);
      boardEl.style.display = 'block';
      if (!seat) {
        boardEl.innerHTML = '<div class="small" style="text-align:center;">Not seated — pick a seat to play</div>';
        return;
      }
      const folded = handData?.folded || {};
      const isActor = handData && seat.seatIndex === handData.actorSeatNum && !folded[current.id] && (seat.stackCents > 0);
      const toCall = handData?.toCallCents || 0;
      const minRaise = handData?.minRaiseCents || 0;
      const callLabel = toCall > 0 ? `Call ${dollars(toCall)}` : 'Check';
      const raiseLabel = `Min-Raise ${dollars(minRaise)}`;
      const actionsHtml = isActor ? `
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-top:8px;">
          <button id="btn-fold">Fold</button>
          <button id="btn-call">${callLabel}</button>
          <button id="btn-raise">${raiseLabel}</button>
        </div>
      ` : '<div class="small" style="text-align:center;margin-top:8px;">Waiting…</div>';
      boardEl.innerHTML = `
        <div style="display:flex; justify-content:center; gap:8px;">
          <span class="card-chip">[ ?? ]</span>
          <span class="card-chip">[ ?? ]</span>
        </div>
        ${actionsHtml}
      `;
      if (isActor) {
        const foldBtn = document.getElementById('btn-fold');
        const callBtn = document.getElementById('btn-call');
        const raiseBtn = document.getElementById('btn-raise');
        const disable = (d) => { foldBtn.disabled = callBtn.disabled = raiseBtn.disabled = d; };
        const intentsCol = collection(db, 'tables', tableId, 'hands', tableData.currentHandId, 'intents');
        const send = async (data) => {
          if (intentPending) return;
          intentPending = true;
          disable(true);
          try {
            await addDoc(intentsCol, { ...data, createdAt: serverTimestamp() });
          } catch (e) {
            console.error(e);
          }
          intentPending = false;
          disable(false);
        };
        foldBtn.addEventListener('click', () => send({ playerId: current.id, type: 'fold' }));
        callBtn.addEventListener('click', () => send({ playerId: current.id, type: toCall > 0 ? 'call' : 'check' }));
        raiseBtn.addEventListener('click', () => send({ playerId: current.id, type: 'raise', amountCents: minRaise }));
      }
    }

    async function claimSeat(seatIndex, cp) {
      await runTransaction(db, async (tx) => {
        const tableRef = doc(db, 'tables', tableId);
        const seatRef = doc(db, 'tables', tableId, 'seats', String(seatIndex));
        const seatSnap = await tx.get(seatRef);
        if (seatSnap.exists() && seatSnap.data()?.occupiedBy) throw new Error('Seat taken');
        tx.set(seatRef, {
          seatIndex,
          seatNum: seatIndex,
          occupiedBy: cp.id,
          playerId: cp.id,
          displayName: cp.name || '',
          playerName: cp.name || '',
          sittingOut: false,
          stackCents: tableData?.defaultBuyInCents || 0,
          chipStackCents: tableData?.defaultBuyInCents || 0,
          updatedAt: serverTimestamp(),
          active: true,
        });
        tx.update(tableRef, { activeSeatCount: increment(1) });
      });
    }

    async function leaveSeat(cp) {
      await runTransaction(db, async (tx) => {
        const tableRef = doc(db, 'tables', tableId);
        const tableSnap = await tx.get(tableRef);
        const maxSeats = tableSnap.data()?.maxSeats || 0;
        let seatRef = null;
        for (let i = 0; i < maxSeats; i++) {
          const sr = doc(db, 'tables', tableId, 'seats', String(i));
          const ss = await tx.get(sr);
          if (ss.exists && ss.data()?.occupiedBy === cp.id) {
            seatRef = sr;
            break;
          }
        }
        if (!seatRef) throw new Error('You are not seated here.');
        tx.update(seatRef, {
          occupiedBy: null,
          playerId: null,
          displayName: null,
          playerName: null,
          sittingOut: false,
          stackCents: null,
          chipStackCents: null,
          updatedAt: serverTimestamp(),
          active: false,
        });
        tx.update(tableRef, { activeSeatCount: increment(-1) });
      });
    }

    function updateDebug() {
      if (!isDebug()) { debugBox.style.display = 'none'; return; }
      debugBox.style.display = 'block';
      const pos = handData?.positions || {};
      const folded = Object.keys(handData?.folded || {}).join(',');
      debugBox.textContent = `id=${tableId}\ncurrentHandId=${tableData?.currentHandId ?? 'null'}\nnextDealerId=${tableData?.nextDealerId ?? 'null'}\nnextDealerName=${tableData?.nextDealerName ?? 'null'}\nnextVariantId=${tableData?.nextVariantId ?? 'null'}\npositions=${pos.dealerSeatNum ?? 'null'},${pos.sbSeatNum ?? 'null'},${pos.bbSeatNum ?? 'null'}\nstage=${handData?.stage ?? 'null'}\nactorSeatNum=${handData?.actorSeatNum ?? 'null'}\nlastAggressorSeatNum=${handData?.lastAggressorSeatNum ?? 'null'}\nroundStartSeatNum=${handData?.roundStartSeatNum ?? 'null'}\ntoCallCents=${handData?.toCallCents ?? 'null'}\nminRaiseCents=${handData?.minRaiseCents ?? 'null'}\ndeckIndex=${handData?.deckIndex ?? 'null'}\nboard=${JSON.stringify(handData?.board || [])}\nfolded=${folded}\nactiveSeatCount=${seatData.filter(s => s.active).length}`;
    }
  </script>
</body>
</html>
